name: AI change (create PR)
on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe the change (what to edit/add)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  ai_edit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate unified diff with OpenAI
        id: llm
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          # Limit context to files we actually want the AI to touch
          tar -czf repo.tar.gz app.py templates/index.html || true
          REPO_B64=$(base64 -w0 repo.tar.gz || base64 repo.tar.gz)

          read -r -d '' SYS <<'SYS'
          You are an expert Flask + Vanilla JS developer.
          Return ONLY a unified diff (patch) that applies with `git apply -p0`.
          Do not include prose, code fences, or backticks.
          Keep lines < 150 chars. Only edit app.py and templates/index.html.
          SYS

          MSG="${{ github.event.inputs.prompt }}"

          # Ask the model for a patch
          PATCH=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @- <<EOF | jq -r '.choices[0].message.content'
          {
            "model": "gpt-4o-mini",
            "temperature": 0.1,
            "messages": [
              {"role": "system", "content": "$SYS"},
              {"role": "user", "content": "Repo (tar.gz, base64): $REPO_B64"},
              {"role": "user", "content": "Task: '"$MSG"'\n\nOnly output a unified diff that edits app.py and/or templates/index.html."}
            ]
          }
          EOF
          )

          echo "$PATCH" > changes.patch

          echo "---- Patch preview ----"
          sed -n '1,120p' changes.patch || true
          echo "-----------------------"

          # Apply patch (stage changes)
          git apply --index changes.patch

      - name: Quick syntax checks
        run: |
          python3 -m pyflakes app.py || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "ai/${{ github.run_id }}"
          commit-message: "AI change: ${{ github.event.inputs.prompt }}"
          title: "AI change: ${{ github.event.inputs.prompt }}"
          body: |
            Prompt:
            > ${{ github.event.inputs.prompt }}

            This PR was generated by the AI workflow. It produced a unified diff which was applied automatically.
          labels: ai
