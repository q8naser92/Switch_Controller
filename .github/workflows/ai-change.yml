---  # yamllint disable rule:line-length
name: AI change (create PR)

'on':
  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe the change you want (be specific)."
        required: true
        default: "Make a small visual tweak in templates/index.html."

jobs:
  ai_edit:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write

    env:
      MODEL_ID: gpt-4.1-mini

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity - python and curl present
        shell: bash
        run: |
          set -euo pipefail
          python3 --version
          curl --version

      - name: Pack allowed files and base64
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          tar czf repo.tar.gz app.py templates/index.html || true
          if command -v base64 >/dev/null 2>&1; then
            REPO_B64="$(base64 -w0 repo.tar.gz 2>/dev/null || base64 < repo.tar.gz)"
          else
            echo "::error::base64 not found"
            exit 1
          fi
          echo "repo_b64=${REPO_B64}" >> "$GITHUB_OUTPUT"

      - name: Generate unified diff with OpenAI
        id: genpatch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL_ID: ${{ env.MODEL_ID }}
          PROMPT: ${{ github.event.inputs.prompt }}
          REPO_B64: ${{ steps.pack.outputs.repo_b64 }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY secret is missing."
            exit 1
          fi

          python3 - <<'PYCODE'
          import json, os, sys, urllib.request
          api = "https://api.openai.com/v1/chat/completions"
          payload = {
            "model": os.environ["MODEL_ID"],
            "temperature": 0.1,
            "messages": [
              {
                "role": "system",
                "content": (
                  "You are an expert software engineer. "
                  "The user will provide a small repo snapshot (tar.gz, base64). "
                  "Return ONLY a unified diff patch (git style) that edits app.py and/or templates/index.html. "
                  "- No prose, no code fences "
                  "- Patch must apply cleanly with `git apply --index` "
                  "- Keep changes minimal and atomic"
                )
              },
              {"role": "user", "content": "Repo (tar.gz, base64):\n" + os.environ["REPO_B64"]},
              {"role": "user", "content": "Task: " + os.environ["PROMPT"] + "\n\nOnly output a unified diff that edits app.py and/or templates/index.html."}
            ]
          }
          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(api, data=data, headers={
            "Authorization": "Bearer " + os.environ["OPENAI_API_KEY"],
            "Content-Type": "application/json",
          })
          try:
            with urllib.request.urlopen(req, timeout=120) as r:
              body = json.loads(r.read().decode("utf-8"))
            content = body["choices"][0]["message"]["content"].strip()
            if content.startswith("```"):
              content = "\n".join(content.splitlines()[1:])
            if content.endswith("```"):
              content = "\n".join(content.splitlines()[:-1])
            open("changes.patch","w").write(content)
            print(content.splitlines()[0] if content else "(empty)")
          except Exception as e:
            sys.stderr.write(f"OPENAI_ERROR: {e}\n")
            sys.exit(1)
          PYCODE

          echo "---- Patch preview (first 60 lines) ----"
          sed -n '1,60p' changes.patch || true

      - name: Apply patch (stage changes)
        shell: bash
        run: |
          set -euo pipefail
          git apply --index changes.patch
          git status --porcelain
          echo "Applied patch."

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "AI edit: ${{ github.event.inputs.prompt }}"
          branch: ai/edit-${{ github.run_number }}
          title: "AI edit: ${{ github.event.inputs.prompt }}"
          body: "Automatically generated by OpenAI. Please review carefully."
          signoff: false
          committer: "nxui-bot <actions@github.com>"
          author: "nxui-bot <actions@github.com>"
