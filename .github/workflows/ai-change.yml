---  # yamllint disable rule:line-length
name: AI change (create PR)

'on':
  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe the change you want (be specific)."
        required: true
        default: "Make a small visual tweak in templates/index.html."

jobs:
  ai_edit:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write

    env:
      MODEL_ID: gpt-4.1-mini

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity - python and curl present
        shell: bash
        run: |
          set -euo pipefail
          python3 --version
          curl --version

      - name: Pack allowed files and base64
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          tar czf repo.tar.gz app.py templates/index.html || true
          if command -v base64 >/dev/null 2>&1; then
            REPO_B64="$(base64 -w0 repo.tar.gz 2>/dev/null || base64 < repo.tar.gz)"
          else
            echo "::error::base64 not found"
            exit 1
          fi
          echo "repo_b64=${REPO_B64}" >> "$GITHUB_OUTPUT"

      - name: Generate unified diff with OpenAI
        id: genpatch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL_ID: gpt-4o-mini
          PROMPT: ${{ github.event.inputs.prompt }}
          REPO_B64: ${{ steps.pack.outputs.repo_b64 }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY secret is missing."
            exit 1
          fi

          python3 - <<'PYCODE'
          import json, os, sys, re, urllib.request

          API = "https://api.openai.com/v1/chat/completions"

          system = (
              "You are an expert software engineer. Output ONLY a git unified diff that "
              "applies cleanly with `git apply --index` against HEAD.\n"
              "Rules:\n"
              "• Edit EXISTING files only: app.py and/or templates/index.html\n"
              "• Use headers exactly like\n"
              "    diff --git a/<path> b/<path>\n"
              "    index <hex>..<hex> 100644 (optional)\n"
              "    --- a/<path>\n"
              "    +++ b/<path>\n"
              "• Include @@ hunk headers and context\n"
              "• No prose, no backticks, no explanations\n"
              "• End with a trailing newline\n"
          )

          payload = {
              "model": os.environ["MODEL_ID"],
              "temperature": 0.0,
              "messages": [
                  {"role": "system", "content": system},
                  {"role": "user", "content": "Repo (tar.gz, base64):\n" + os.environ["REPO_B64"]},
                  {"role": "user", "content": "Task: " + os.environ["PROMPT"] +
                                               "\n\nOnly output a unified diff that edits app.py and/or templates/index.html."}
              ],
          }

          req = urllib.request.Request(
              API,
              data=json.dumps(payload).encode("utf-8"),
              headers={
                  "Authorization": "Bearer " + os.environ["OPENAI_API_KEY"],
                  "Content-Type": "application/json",
              },
          )

          # ---- call model ----
          try:
              with urllib.request.urlopen(req, timeout=120) as r:
                  body = json.loads(r.read().decode("utf-8"))
              raw = body["choices"][0]["message"]["content"].strip()
          except Exception as e:
              sys.stderr.write(f"OPENAI_ERROR: {e}\n")
              sys.exit(1)

          # ---- strip code fences ----
          if raw.startswith("```"):
              lines = raw.splitlines()
              if lines[-1].strip().startswith("```"):
                  lines = lines[1:-1]
              else:
                  lines = lines[1:]
              raw = "\n".join(lines).strip()

          # keep only from first diff header
          m = re.search(r'^(?:diff --git |--- a/)', raw, flags=re.M)
          if m:
              raw = raw[m.start():]
          else:
              sys.stderr.write("SANITIZE_ERROR: no diff header found in model output\n")
              sys.exit(1)

          lines = raw.splitlines()

          # ---- repair headers if missing ----
          out = []
          cur_path = None
          i = 0
          while i < len(lines):
              line = lines[i]

              if line.startswith("diff --git "):
                  out.append(line)
                  parts = line.strip().split()
                  if len(parts) >= 4 and parts[2].startswith("a/") and parts[3].startswith("b/"):
                      cur_path = parts[2][2:]
                  else:
                      cur_path = None

                  j = i + 1
                  if j < len(lines) and lines[j].startswith("index "):
                      out.append(lines[j])
                      j += 1

                  if j < len(lines) and lines[j].startswith("--- a/"):
                      out.append(lines[j])
                      j += 1
                  else:
                      if not cur_path:
                          sys.stderr.write("VALIDATION_ERROR: cannot infer path for --- header\n")
                          sys.exit(1)
                      out.append(f"--- a/{cur_path}")

                  if j < len(lines) and lines[j].startswith("+++ b/"):
                      out.append(lines[j])
                      j += 1
                  else:
                      if not cur_path:
                          sys.stderr.write("VALIDATION_ERROR: cannot infer path for +++ header\n")
                          sys.exit(1)
                      out.append(f"+++ b/{cur_path}")

                  i = j
                  continue

              if line.startswith("@@"):
                  if not any(x.startswith("--- a/") for x in out[-3:]) or not any(x.startswith("+++ b/") for x in out[-3:]):
                      sys.stderr.write("VALIDATION_ERROR: hunk appeared without file headers\n")
                      sys.exit(1)
                  out.append(line)
                  i += 1
                  continue

              out.append(line)
              i += 1

          patch = "\n".join(out).rstrip("\n") + "\n"

          for m in re.finditer(r'^(?:diff --git a/|--- a/|\+\+\+ b/)(.+)$', patch, flags=re.M):
              path = m.group(1).split()[-1]
              path = path.replace('a/','').replace('b/','')
              if path not in ("app.py", "templates/index.html"):
                  sys.stderr.write(f"VALIDATION_ERROR: unexpected path in patch: {path}\n")
                  sys.exit(1)

          open("changes.patch", "w", encoding="utf-8").write(patch)
          print(patch.splitlines()[0] if patch else "(empty)")
          PYCODE

          echo "---- Patch preview (first 80 lines) ----"
          nl -ba -w2 -s': ' changes.patch | sed -n '1,80p' || true


      - name: Apply patch (stage changes)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Step 1: Normalize patch ==="
          if command -v dos2unix >/dev/null 2>&1; then
            dos2unix -q changes.patch || true
          else
            sed -i 's/\r$//' changes.patch || true
          fi
          git config core.autocrlf false

          echo "=== Step 2: Show patch summary (first + last 40 lines) ==="
          echo "::group::changes.patch (head)"
          nl -ba -w2 -s': ' changes.patch | sed -n '1,40p' || true
          echo "::endgroup::"
          echo "::group::changes.patch (tail)"
          nl -ba -w2 -s': ' changes.patch | tail -n 40 || true
          echo "::endgroup::"

          echo "=== Step 3: Dry-run check ==="
          if git apply --check changes.patch 2>apply.err; then
            echo "Patch validated cleanly with --check ✅"
            git apply --index changes.patch
            echo "Patch applied successfully (direct)."
          else
            echo "::warning:: --check failed; showing errors and trying 3-way merge"
            echo "::group::git apply --check stderr"
            sed -n '1,200p' apply.err || true
            echo "::endgroup::"

            echo "=== Attempting 3-way merge apply ==="
            if git apply --3way --index changes.patch 2>apply3.err; then
              echo "Patch applied successfully using 3-way merge ✅"
            else
              echo "::group::git apply --3way stderr"
              sed -n '1,200p' apply3.err || true
              echo "::endgroup::"

              echo "::group::Current diff (context)"
              git --no-pager diff --stat || true
              echo "::endgroup::"

              echo "::error file=changes.patch::Patch did not apply cleanly."
              exit 1
            fi
          fi

          echo "=== Step 4: Git status ==="
          git status --porcelain

          echo "=== Step 5: Show resulting diff (first 80 lines) ==="
          git --no-pager diff --cached | head -n 80 || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "AI edit: ${{ github.event.inputs.prompt }}"
          branch: ai/edit-${{ github.run_number }}
          title: "AI edit: ${{ github.event.inputs.prompt }}"
          body: "Automatically generated by OpenAI. Please review carefully."
          signoff: false
          committer: "nxui-bot <actions@github.com>"
          author: "nxui-bot <actions@github.com>"
