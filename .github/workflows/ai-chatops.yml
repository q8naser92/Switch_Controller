---  # yamllint disable rule:line-length
name: AI ChatOps (comment -> PR)

'on':
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-chatops-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  ai_edit:
    if: >
      (github.event.comment.body && startsWith(github.event.comment.body, '/ai')) ||
      (github.event.comment.body && startsWith(github.event.comment.body, '/ai:'))
    runs-on: self-hosted

    env:
      MODEL_ID: gpt-4o-mini
      REPO_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      COMMENT_BODY: ${{ github.event.comment.body }}
      COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
      REPO_OWNER: ${{ github.repository_owner }}

    steps:
      - name: Authorize (repo owner only)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${COMMENT_AUTHOR}" != "${REPO_OWNER}" ]; then
            echo "::error::Only @${REPO_OWNER} may run /ai by default."
            exit 1
          fi

      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.REPO_DEFAULT_BRANCH }}

      - name: Extract prompt from comment
        id: prompt
        shell: bash
        run: |
          set -euo pipefail
          P="${COMMENT_BODY}"
          P="${P#/ai }"; P="${P#/ai: }"
          {
            echo "prompt<<EOF"
            echo "$P"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          printf "Prompt: %s\n" "$P"

      - name: Pack allowed files and base64
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          tar czf repo.tar.gz app.py templates/index.html 2>/dev/null || true
          if command -v base64 >/dev/null 2>&1; then
            REPO_B64="$(base64 -w0 repo.tar.gz 2>/dev/null || base64 < repo.tar.gz)"
          else
            echo "::error::base64 not found"
            exit 1
          fi
          echo "repo_b64=${REPO_B64}" >> "$GITHUB_OUTPUT"

      - name: Generate unified diff with OpenAI
        id: genpatch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL_ID: ${{ env.MODEL_ID }}
          PROMPT: ${{ steps.prompt.outputs.prompt }}
          REPO_B64: ${{ steps.pack.outputs.repo_b64 }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY secret is missing."
            exit 1
          fi

          cat > ai_request.py <<'PYCODE'
          import json, os, sys, re, urllib.request

          API = "https://api.openai.com/v1/chat/completions"
          system = (
              "You are an expert software engineer. Output ONLY a git unified diff that "
              "applies cleanly with `git apply --index` against HEAD.\n"
              "Rules:\n"
              "- Edit EXISTING files only: app.py and/or templates/index.html\n"
              "- Use headers exactly like:\n"
              "    diff --git a/<path> b/<path>\n"
              "    --- a/<path>\n"
              "    +++ b/<path>\n"
              "- Include @@ hunk headers and context\n"
              "- No prose, no backticks, no explanations\n"
              "- End with a trailing newline\n"
          )

          payload = {
              "model": os.environ["MODEL_ID"],
              "temperature": 0.0,
              "messages": [
                  {"role": "system", "content": system},
                  {"role": "user", "content": "Repo (tar.gz, base64):\n" + os.environ["REPO_B64"]},
                  {"role": "user", "content": "Task: " + os.environ["PROMPT"] +
                                               "\n\nOnly output a unified diff that edits app.py and/or templates/index.html."}
              ],
          }

          req = urllib.request.Request(
              API,
              data=json.dumps(payload).encode("utf-8"),
              headers={
                  "Authorization": "Bearer " + os.environ["OPENAI_API_KEY"],
                  "Content-Type": "application/json",
              },
          )

          try:
              with urllib.request.urlopen(req, timeout=120) as r:
                  body = json.loads(r.read().decode("utf-8"))
              content = body["choices"][0]["message"]["content"].strip()
          except Exception as e:
              sys.stderr.write(f"OPENAI_ERROR: {e}\n")
              sys.exit(1)

          # Remove code fences
          if content.startswith("```"):
              lines = content.splitlines()
              if lines and lines[-1].strip().startswith("```"):
                  lines = lines[1:-1]
              else:
                  lines = lines[1:]
              content = "\n".join(lines).strip()

          if not content:
              sys.stderr.write("VALIDATION_ERROR: empty patch\n")
              sys.exit(1)

          open("changes.patch", "w", encoding="utf-8").write(content)
          print("Patch created successfully.")
          PYCODE

          python3 ai_request.py

      - name: Apply patch and commit
        shell: bash
        run: |
          set -euo pipefail
          git config core.autocrlf false
          git config user.name "nxui-bot"
          git config user.email "actions@github.com"

          if ! git apply --check changes.patch; then
            echo "::warning::Patch failed --check, trying 3-way"
            git apply --3way changes.patch || {
              echo "::error::Patch did not apply cleanly."
              exit 1
            }
          fi

          BR=ai/chat-${GITHUB_RUN_NUMBER}
          git checkout -b "$BR"
          git apply --index changes.patch
          git commit -m "AI edit: ${{ steps.prompt.outputs.prompt }}" || echo "Nothing to commit"
          git push --set-upstream origin "$BR"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ai/chat-${{ github.run_number }}
          title: "AI: ${{ steps.prompt.outputs.prompt }}"
          body: "Generated automatically by AI ChatOps. Please review carefully."
          base: ${{ env.REPO_DEFAULT_BRANCH }}
          commit-message: "AI edit: ${{ steps.prompt.outputs.prompt }}"
