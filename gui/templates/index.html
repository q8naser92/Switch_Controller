<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NXBT Control Panel (Deployed)</title>
<style>
  :root{
    --bg:#0e1116; --panel:#151a22; --muted:#98a2b3; --text:#e5e7eb;
    --accent:#7c3aed; --accent-2:#22c55e; --danger:#ef4444; --active:#0ea5e9; --file:#f59e0b;
    --btn:#1f2937; --btn-hover:#374151; --ring:0 0 0 2px rgba(124,58,237,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{background:var(--panel);border:1px solid #1f2430;border-radius:12px;padding:12px}
  .head{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
  .title{font-weight:700}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:0;background:var(--btn);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;transition:transform .05s ease, background .12s ease, box-shadow .12s ease}
  .btn:hover{background:var(--btn-hover)}
  .btn:active{transform:translateY(1px)}
  .btn.on{background:var(--accent-2)}
  .btn.danger{background:var(--danger)}
  .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
  .btn.flash{box-shadow:var(--ring)}
  pre.log{height:260px;overflow:auto;background:#0b0e13;border:1px solid #1c2230;border-radius:8px;padding:10px;white-space:pre-wrap;margin:0}
  .bottom{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  .cmds{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .cmds h4{grid-column:1 / -1;margin:8px 0 2px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
  .fileTabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:6px 10px;border-radius:8px;background:#111522;cursor:pointer;border:1px solid #1e2635;color:var(--muted)}
  .tab.active{color:#111;border-color:#703aed;background:linear-gradient(180deg,#fbbf24,#f59e0b)}
  .fileBox{background:#0b0e13;border:1px solid #1c2230;border-radius:10px;padding:10px}
  .fileRow{display:flex;gap:10px;align-items:center;padding:4px 0;border-bottom:1px dotted #21283a}
  .ln{width:36px;text-align:right;color:#6b7280}
  .lt{flex:1}
  .del{background:#19202d;color:#fca5a5;border:1px solid #3b1a1a}
  .edit{background:#18282b;color:#93c5fd;border:1px solid #1c3b57}
  .timelbl{color:var(--muted);font-size:12px}
  .hlTarget{box-shadow:0 0 0 2px rgba(14,165,233,.35)}
  input.txt{width:80px;background:#0b0e13;color:#e5e7eb;border:1px solid #1c2230;border-radius:8px;padding:6px 8px}
  .chip{font-size:11px;padding:3px 6px;border-radius:999px;background:#0f1420;border:1px solid #1c2230;color:#a3a9b6}
  .ctrl-btn{
    appearance:none;border:2px solid #2d3748;background:#1a202c;color:var(--text);
    padding:12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:16px;
    transition:all .15s ease;min-width:60px;min-height:60px;
  }
  .ctrl-btn.small{min-width:50px;min-height:50px;padding:8px;font-size:14px}
  .ctrl-btn:hover{background:#2d3748;border-color:var(--accent);transform:scale(1.05)}
  .ctrl-btn:active,.ctrl-btn.pressed{background:var(--accent);border-color:var(--accent);transform:scale(0.95)}
  .ctrl-btn.holding{background:var(--accent-2);border-color:var(--accent-2);animation:pulse 0.5s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
</style>
</head>
<body>
<div class="wrap">
  <!-- Service Status Panel -->
  <div class="panel" style="margin-bottom:16px">
    <div class="head">
      <div class="title">Service Status</div>
      <div class="controls">
        <button class="btn small" id="btnRestartService">Restart nxui.service</button>
      </div>
    </div>
    <div style="display:flex;gap:20px;align-items:center;padding:8px 0">
      <div>
        <span class="timelbl">Status:</span>
        <span id="serviceStatus" class="chip" style="margin-left:8px;font-weight:600">checking...</span>
      </div>
      <div>
        <span class="timelbl">Hostname:</span>
        <span id="serverHostname" style="margin-left:8px;color:var(--text)">loading...</span>
      </div>
      <div>
        <span class="timelbl">IP:</span>
        <span id="serverIP" style="margin-left:8px;color:var(--text)">loading...</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Bluetooth pane -->
    <div class="panel">
      <div class="head">
        <div class="title">Bluetooth (bluetoothctl)</div>
        <div class="controls">
          <button class="btn small" id="btStart">Start</button>
          <button class="btn small" id="btPair">Pair (yes‚Üµ)</button>
          <button class="btn small danger" id="btStop">Stop</button>
        </div>
      </div>
      <pre class="log" id="btLog">(no logs yet)</pre>
    </div>

    <!-- Program pane -->
    <div class="panel">
      <div class="head">
        <div class="title">Program (nxbt_loop.py)</div>
        <div class="controls">
          <button class="btn small" id="pgStart">Start</button>
          <button class="btn small" id="pgStatus">Status</button>
          <button class="btn small danger" id="pgStop">Stop</button>
          <button class="btn small danger" id="pgQuit">Quit</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <span class="timelbl">Mode:</span>
        <button class="btn small" id="modeManual" data-mode="manual">Manual</button>
        <button class="btn small" id="modeA" data-mode="a">RUN</button>
        <button class="btn small" id="modeB" data-mode="b">LOOP</button>
        <button class="btn small" id="modeC" data-mode="c">INIT</button>
      </div>
      <pre class="log" id="pgLog">(no logs yet)</pre>
    </div>
  </div>

  <div class="panel bottom">
    <!-- Commands / adders -->
    <div>
      <div class="fileTabs">
        <div class="tab" id="tabInit" data-file="init">init.txt</div>
        <div class="tab" id="tabLoop" data-file="loop">loop.txt</div>
      </div>

      <!-- Presets section -->
      <div style="background:#0f1420;border:1px solid #1c2230;border-radius:10px;padding:10px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span class="timelbl" style="font-weight:600">Presets:</span>
          <input id="presetName" class="txt" type="text" placeholder="preset name" style="width:140px">
          <button class="btn small" id="btnSavePreset">Save loop.txt</button>
          <button class="btn small" id="btnRefreshPresets">Refresh</button>
        </div>
        <div id="presetsList" style="max-height:120px;overflow:auto"></div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin:6px 0 12px">
        <span class="timelbl">Duration:</span>
        <input id="dur" class="txt" type="text" value="0.2s">
        <button class="btn small" id="btnWait" title="Append a pure wait line like '0.2s'">Add Wait</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin:6px 0 12px">
        <span class="timelbl">Action Mode:</span>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input type="radio" name="actionMode" value="hold" id="actionModeHold" checked>
          <span>Hold</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input type="radio" name="actionMode" value="release" id="actionModeRelease">
          <span>Release</span>
        </label>
        <span class="chip">Commands will be written as hold/release (no time)</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin:6px 0 12px">
        <span class="timelbl">Insert at line:</span>
        <input id="lineNum" class="txt" type="text" placeholder="(end)" title="Leave empty to append at end, or specify line number to insert at">
        <span class="chip">Optional: Leave empty to append at end</span>
      </div>

      <div class="cmds">
        <h4>Buttons</h4>
        <button class="btn small cmd" data-c="Y">Y</button>
        <button class="btn small cmd" data-c="X">X</button>
        <button class="btn small cmd" data-c="B">B</button>
        <button class="btn small cmd" data-c="A">A</button>

        <h4>D-Pad</h4>
        <button class="btn small cmd" data-c="DPAD_UP">DPAD_UP</button>
        <button class="btn small cmd" data-c="DPAD_DOWN">DPAD_DOWN</button>
        <button class="btn small cmd" data-c="DPAD_LEFT">DPAD_LEFT</button>
        <button class="btn small cmd" data-c="DPAD_RIGHT">DPAD_RIGHT</button>

        <h4>Shoulders</h4>
        <button class="btn small cmd" data-c="L">L</button>
        <button class="btn small cmd" data-c="ZL">ZL</button>
        <button class="btn small cmd" data-c="R">R</button>
        <button class="btn small cmd" data-c="ZR">ZR</button>

        <h4>Meta</h4>
        <button class="btn small cmd" data-c="PLUS">PLUS</button>
        <button class="btn small cmd" data-c="MINUS">MINUS</button>
        <button class="btn small cmd" data-c="HOME">HOME</button>
        <button class="btn small cmd" data-c="CAPTURE">CAPTURE</button>

        <h4>Left Stick</h4>
        <button class="btn small cmd" data-c="L_STICK@-100+000">Left ‚Üê</button>
        <button class="btn small cmd" data-c="L_STICK@+100+000">Left ‚Üí</button>
        <button class="btn small cmd" data-c="L_STICK@+000+100">Left ‚Üë</button>
        <button class="btn small cmd" data-c="L_STICK@+000-100">Left ‚Üì</button>
        <button class="btn small cmd" data-c="L_STICK@-100+100">Left ‚Üñ</button>
        <button class="btn small cmd" data-c="L_STICK@+100+100">Left ‚Üó</button>
        <button class="btn small cmd" data-c="L_STICK@-100-100">Left ‚Üô</button>
        <button class="btn small cmd" data-c="L_STICK@+100-100">Left ‚Üò</button>

        <h4>Right Stick</h4>
        <button class="btn small cmd" data-c="R_STICK@-100+000">Right ‚Üê</button>
        <button class="btn small cmd" data-c="R_STICK@+100+000">Right ‚Üí</button>
        <button class="btn small cmd" data-c="R_STICK@+000+100">Right ‚Üë</button>
        <button class="btn small cmd" data-c="R_STICK@+000-100">Right ‚Üì</button>
        <button class="btn small cmd" data-c="R_STICK@-100+100">Right ‚Üñ</button>
        <button class="btn small cmd" data-c="R_STICK@+100+100">Right ‚Üó</button>
        <button class="btn small cmd" data-c="R_STICK@-100-100">Right ‚Üô</button>
        <button class="btn small cmd" data-c="R_STICK@+100-100">Right ‚Üò</button>
      </div>
    </div>

    <!-- File viewer/editor -->
    <div>
      <div class="head" style="margin-bottom:6px">
        <div class="title">Active file</div>
        <div class="controls">
          <button class="btn small" id="refreshFile">Refresh</button>
        </div>
      </div>
      <div class="fileBox" id="fileBox"></div>
    </div>
  </div>
</div>

<!-- Virtual Controller Overlay (for manual mode) -->
<div id="controllerOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;justify-content:center;align-items:center">
  <div style="background:var(--panel);border:2px solid var(--accent);border-radius:20px;padding:30px;position:relative;max-width:1200px;display:flex;gap:20px">
    <button id="closeOverlay" style="position:absolute;top:15px;right:15px;background:var(--danger);color:white;border:0;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;z-index:10">Close</button>
    
    <!-- Controller Section -->
    <div style="flex:1">
      <h2 style="margin:0 0 20px 0;color:var(--accent);text-align:center">Virtual Controller - Manual Mode</h2>
      
      <div style="font-size:12px;color:var(--muted);margin-bottom:20px;text-align:center">
        <strong>Press:</strong> Sends hold on press, release on mouse up &nbsp;|&nbsp; <strong>Alt+Click:</strong> Toggle persistent hold (stays until alt+click again)
      </div>
      
      <!-- Controller layout: LEFT - CENTER - RIGHT -->
      <div style="display:grid;grid-template-columns:220px 100px 220px;gap:20px;align-items:start;justify-content:center">
        
        <!-- LEFT section: ZL, L, MINUS, DPAD, LEFTSTICK -->
        <div style="display:flex;flex-direction:column;gap:15px;align-items:center">
          <!-- ZL and L -->
          <div style="display:flex;flex-direction:column;gap:8px;width:100%">
            <button class="ctrl-btn" data-btn="ZL" style="width:100%">ZL</button>
            <button class="ctrl-btn" data-btn="L" style="width:100%">L</button>
          </div>
          
          <!-- MINUS -->
          <button class="ctrl-btn" data-btn="MINUS" style="width:60px">‚àí</button>
          
          <!-- D-Pad -->
          <div style="display:grid;grid-template-columns:repeat(3,60px);grid-template-rows:repeat(3,60px);gap:2px">
            <div></div>
            <button class="ctrl-btn" data-btn="DPAD_UP">‚Üë</button>
            <div></div>
            <button class="ctrl-btn" data-btn="DPAD_LEFT">‚Üê</button>
            <div></div>
            <button class="ctrl-btn" data-btn="DPAD_RIGHT">‚Üí</button>
            <div></div>
            <button class="ctrl-btn" data-btn="DPAD_DOWN">‚Üì</button>
            <div></div>
          </div>
          
          <!-- Left Stick -->
          <div style="display:flex;flex-direction:column;align-items:center">
            <div style="color:var(--muted);font-size:11px;margin-bottom:5px">L Stick</div>
            <div style="display:grid;grid-template-columns:repeat(3,50px);grid-template-rows:repeat(3,50px);gap:2px">
              <button class="ctrl-btn small" data-btn="L_STICK@-100+100">‚Üñ</button>
              <button class="ctrl-btn small" data-btn="L_STICK@+000+100">‚Üë</button>
              <button class="ctrl-btn small" data-btn="L_STICK@+100+100">‚Üó</button>
              <button class="ctrl-btn small" data-btn="L_STICK@-100+000">‚Üê</button>
              <button class="ctrl-btn small" data-btn="L_STICK_PRESS">L3</button>
              <button class="ctrl-btn small" data-btn="L_STICK@+100+000">‚Üí</button>
              <button class="ctrl-btn small" data-btn="L_STICK@-100-100">‚Üô</button>
              <button class="ctrl-btn small" data-btn="L_STICK@+000-100">‚Üì</button>
              <button class="ctrl-btn small" data-btn="L_STICK@+100-100">‚Üò</button>
            </div>
          </div>
        </div>
        
        <!-- CENTER section: CAPTURE, HOME -->
        <div style="display:flex;flex-direction:column;gap:15px;align-items:center;justify-content:center">
          <button class="ctrl-btn" data-btn="CAPTURE" style="width:60px">üì∑</button>
          <button class="ctrl-btn" data-btn="HOME" style="width:60px">üè†</button>
        </div>
        
        <!-- RIGHT section: ZR, R, PLUS, ABXY, RIGHTSTICK -->
        <div style="display:flex;flex-direction:column;gap:15px;align-items:center">
          <!-- ZR and R -->
          <div style="display:flex;flex-direction:column;gap:8px;width:100%">
            <button class="ctrl-btn" data-btn="ZR" style="width:100%">ZR</button>
            <button class="ctrl-btn" data-btn="R" style="width:100%">R</button>
          </div>
          
          <!-- PLUS -->
          <button class="ctrl-btn" data-btn="PLUS" style="width:60px">+</button>
          
          <!-- ABXY buttons -->
          <div style="display:grid;grid-template-columns:repeat(3,60px);grid-template-rows:repeat(3,60px);gap:2px">
            <div></div>
            <button class="ctrl-btn" data-btn="X" style="background:#5d7aa8">X</button>
            <div></div>
            <button class="ctrl-btn" data-btn="Y" style="background:#6aa86d">Y</button>
            <div></div>
            <button class="ctrl-btn" data-btn="A" style="background:#a86a6a">A</button>
            <div></div>
            <button class="ctrl-btn" data-btn="B" style="background:#a8a86a">B</button>
            <div></div>
          </div>
          
          <!-- Right Stick -->
          <div style="display:flex;flex-direction:column;align-items:center">
            <div style="color:var(--muted);font-size:11px;margin-bottom:5px">R Stick</div>
            <div style="display:grid;grid-template-columns:repeat(3,50px);grid-template-rows:repeat(3,50px);gap:2px">
              <button class="ctrl-btn small" data-btn="R_STICK@-100+100">‚Üñ</button>
              <button class="ctrl-btn small" data-btn="R_STICK@+000+100">‚Üë</button>
              <button class="ctrl-btn small" data-btn="R_STICK@+100+100">‚Üó</button>
              <button class="ctrl-btn small" data-btn="R_STICK@-100+000">‚Üê</button>
              <button class="ctrl-btn small" data-btn="R_STICK_PRESS">R3</button>
              <button class="ctrl-btn small" data-btn="R_STICK@+100+000">‚Üí</button>
              <button class="ctrl-btn small" data-btn="R_STICK@-100-100">‚Üô</button>
              <button class="ctrl-btn small" data-btn="R_STICK@+000-100">‚Üì</button>
              <button class="ctrl-btn small" data-btn="R_STICK@+100-100">‚Üò</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Input History Section -->
    <div style="width:300px;background:#0b0e13;border:1px solid #1c2230;border-radius:10px;padding:15px;display:flex;flex-direction:column;max-height:600px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="color:var(--muted);font-weight:600;font-size:14px">Input History</div>
        <button id="clearHistory" class="btn small" style="padding:4px 8px">Clear</button>
      </div>
      
      <div id="inputHistory" style="flex:1;overflow-y:auto;background:#0b0e13;border:1px solid #1c2230;border-radius:8px;padding:8px;min-height:400px;max-height:450px;font-family:monospace;font-size:12px;color:var(--text);margin-bottom:10px">
        <div style="color:var(--muted);font-style:italic">No inputs yet</div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="presetNameInput" class="txt" type="text" placeholder="Preset name" style="width:100%">
        <button id="saveHistoryPreset" class="btn small" style="width:100%">Save to Preset</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
function flash(el){ el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'), 180); }
function setLog(el, text){
  const keep = 100;
  const lines = (text||'').split('\n');
  el.textContent = lines.slice(-keep).join('\n');
  el.scrollTop = el.scrollHeight;
}

/* ---------- elements ---------- */
const btLog = $('#btLog'), pgLog = $('#pgLog'), fileBox = $('#fileBox');
const tabInit = $('#tabInit'), tabLoop = $('#tabLoop'),
      dur = $('#dur'), btnWait = $('#btnWait'), lineNum = $('#lineNum');

let activeFile = 'loop';   // tab shown on right and target for appending commands

function updateTabs(which){
  activeFile = which;
  tabInit.classList.toggle('active', which==='init');
  tabLoop.classList.toggle('active', which==='loop');
  loadFile();
}

tabInit.onclick = ()=>updateTabs('init');
tabLoop.onclick = ()=>updateTabs('loop');

async function jpost(url, body){
  const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{})});
  return r.json().catch(()=> ({}));
}
async function jget(url){
  const r = await fetch(url);
  return r.json().catch(()=> ({}));
}

/* ---------- Bluetooth buttons ---------- */
$('#btStart').onclick = async (e)=>{ flash(e.target); await jpost('/bluetooth/start'); };
$('#btStop').onclick  = async (e)=>{ flash(e.target); await jpost('/bluetooth/stop');  };
$('#btPair').onclick  = async (e)=>{ flash(e.target); await jpost('/bluetooth/pair');  };

/* ---------- Program buttons ---------- */
$('#pgStart').onclick = async (e)=>{ flash(e.target); await jpost('/program/start'); };
$('#pgStatus').onclick = async (e)=>{ flash(e.target); await jpost('/program/status'); };
$('#pgStop').onclick = async (e)=>{ flash(e.target); await jpost('/program/stop'); };
$('#pgQuit').onclick = async (e)=>{ flash(e.target); await jpost('/program/quit'); };

/* ---------- Mode buttons ---------- */
const modeButtons = [$('#modeManual'), $('#modeA'), $('#modeB'), $('#modeC')];
modeButtons.forEach(btn => {
  btn.onclick = async (e) => {
    flash(e.target);
    const mode = btn.dataset.mode;
    await jpost('/program/mode', { mode });
    
    // Show controller overlay only for manual mode
    if (mode === 'manual') {
      $('#controllerOverlay').style.display = 'flex';
    }
  };
});

/* ---------- Service Status ---------- */
const serviceStatus = $('#serviceStatus'), serverHostname = $('#serverHostname'), serverIP = $('#serverIP');
const btnRestartService = $('#btnRestartService');

async function pollServiceStatus(){
  try{
    const data = await jget('/service/status');
    if(data.ok){
      const status = data.status || 'unknown';
      serviceStatus.textContent = status;
      // Update chip color based on status
      if(status === 'active'){
        serviceStatus.style.background = 'var(--accent-2)';
        serviceStatus.style.color = '#111';
      } else if(status === 'inactive' || status === 'failed'){
        serviceStatus.style.background = 'var(--danger)';
        serviceStatus.style.color = '#fff';
      } else {
        serviceStatus.style.background = '#f59e0b';
        serviceStatus.style.color = '#111';
      }
    }
  }catch(_){}
}

async function loadServerInfo(){
  try{
    const data = await jget('/service/info');
    if(data.ok){
      serverHostname.textContent = data.hostname || 'unknown';
      serverIP.textContent = (data.ips && data.ips.length > 0) ? data.ips.join(', ') : 'unknown';
    }
  }catch(_){}
}

btnRestartService.onclick = async (e)=>{
  if(!confirm('Are you sure you want to restart the nxui.service? This will disconnect you temporarily.')){
    return;
  }
  flash(e.target);
  try{
    const result = await jpost('/service/restart');
    if(result.ok){
      alert('Service restart initiated. The page will reload in 5 seconds...');
      setTimeout(()=>{ window.location.reload(); }, 5000);
    } else {
      alert('Failed to restart service: ' + (result.error || 'unknown error'));
    }
  }catch(err){
    alert('Error restarting service: ' + err);
  }
};

// Poll service status every 5 seconds
setInterval(pollServiceStatus, 5000);
pollServiceStatus();
loadServerInfo();

/* ---------- Logs polling ---------- */
async function pollLogs(){
  try{ const b = await jget('/bluetooth/log'); setLog(btLog, b.log); }catch(_){}
  try{ const p = await jget('/program/log');   setLog(pgLog, p.log); }catch(_){}
}
setInterval(pollLogs, 1000);
pollLogs();

/* ---------- Append commands ---------- */
function getActionMode() {
  return document.querySelector('input[name="actionMode"]:checked').value;
}

function buildLine(cmd, d){
  const actionMode = getActionMode();
  
  // For stick commands, convert to hold_stick or release_stick format
  if (cmd.includes('L_STICK@') || cmd.includes('R_STICK@')) {
    const stick = cmd.split('@')[0]; // "L_STICK" or "R_STICK"
    const coords = cmd.split('@')[1]; // "+000+100" etc
    
    if (actionMode === 'hold') {
      // Parse coordinates: +000+100 -> x=0, y=100
      const x = parseInt(coords.substring(0, 4));
      const y = parseInt(coords.substring(4, 8));
      return `hold_stick ${stick} ${x} ${y}`;
    } else {
      return `release_stick ${stick}`;
    }
  }
  
  // For button commands
  if (actionMode === 'hold') {
    return `hold ${cmd}`;
  } else {
    return `release ${cmd}`;
  }
}

document.querySelectorAll('.cmd').forEach(btn=>{
  btn.onclick = async ()=>{
    flash(btn);
    const line = buildLine(btn.dataset.c, dur.value);
    const payload = { which: activeFile, line };
    const ln = (lineNum.value||'').trim();
    if (ln) payload.line_number = parseInt(ln, 10);
    await jpost('/files/append', payload);
    loadFile();
  }
});

btnWait.onclick = async (e)=>{
  flash(e.target);
  const t = (dur.value||'').trim();
  if (!t) return;
  const payload = { which: activeFile, line: t };
  const ln = (lineNum.value||'').trim();
  if (ln) payload.line_number = parseInt(ln, 10);
  await jpost('/files/append', payload);
  loadFile();
};

/* ---------- File render / delete / edit ---------- */
async function loadFile(){
  const data = await jget(`/files?which=${activeFile}`);
  if(!data || !data.lines){ fileBox.textContent='(failed to load)'; return; }
  fileBox.innerHTML = '';
  data.lines.forEach(row=>{
    const div = document.createElement('div');
    div.className = 'fileRow';

    const ln = document.createElement('div');
    ln.className = 'ln';
    ln.textContent = row.n;

    const lt = document.createElement('div');
    lt.className = 'lt';
    lt.textContent = row.t;

    // Edit button
    const edit = document.createElement('button');
    edit.className = 'btn small edit';
    edit.textContent = 'Edit';
    edit.onclick = ()=>{
      // swap into inline editor
      const original = row.t;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = original;
      input.style.width = '100%';
      input.className = 'txt';
      const save = document.createElement('button');
      save.className = 'btn small';
      save.textContent = 'Save';
      const cancel = document.createElement('button');
      cancel.className = 'btn small danger';
      cancel.textContent = 'Cancel';

      const editor = document.createElement('div');
      editor.style.display = 'flex';
      editor.style.gap = '8px';
      editor.style.width = '100%';
      editor.appendChild(input);
      editor.appendChild(save);
      editor.appendChild(cancel);

      // replace text with editor
      div.replaceChild(editor, lt);

      save.onclick = async ()=>{
        flash(save);
        const new_text = input.value.trim();
        if (!new_text) return;
        await jpost('/files/modify', { which: activeFile, line_number: row.n, new_text });
        loadFile();
      };
      cancel.onclick = ()=>{ flash(cancel); loadFile(); };
    };

    // Delete button
    const del = document.createElement('button');
    del.className = 'btn small del';
    del.textContent = 'Delete';
    del.onclick = async ()=>{
      flash(del);
      await jpost('/files/delete', { which: activeFile, line_number: row.n });
      loadFile();
    };

    div.appendChild(ln);
    div.appendChild(lt);
    div.appendChild(edit);
    div.appendChild(del);
    fileBox.appendChild(div);
  });
}
$('#refreshFile').onclick = loadFile;

/* ---------- Presets ---------- */
const presetName = $('#presetName'), presetsList = $('#presetsList');
const btnSavePreset = $('#btnSavePreset'), btnRefreshPresets = $('#btnRefreshPresets');

async function loadPresets(){
  try{
    const data = await jget('/presets/list');
    if(!data.ok || !data.presets){ presetsList.textContent='(failed to load presets)'; return; }
    
    if(data.presets.length === 0){
      presetsList.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:4px">No presets saved yet</div>';
      return;
    }
    
    presetsList.innerHTML = '';
    data.presets.forEach(preset=>{
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;gap:8px;align-items:center;padding:4px 0;border-bottom:1px dotted #21283a';
      
      const name = document.createElement('div');
      name.style.cssText = 'flex:1;color:var(--text);cursor:pointer';
      name.textContent = preset.name;
      name.title = 'Click to view preset contents';
      name.onclick = async ()=>{
        // View preset contents in the file viewer
        try{
          const viewData = await jget(`/presets/view?filename=${encodeURIComponent(preset.filename)}`);
          if(!viewData || !viewData.lines){ alert('Failed to load preset'); return; }
          
          // Render in file box
          fileBox.innerHTML = '';
          const title = document.createElement('div');
          title.style.cssText = 'color:var(--file);font-weight:600;margin-bottom:8px;padding:4px 0;border-bottom:1px solid #1c2230';
          title.textContent = `Preset: ${preset.name}`;
          fileBox.appendChild(title);
          
          viewData.lines.forEach(row=>{
            const div = document.createElement('div');
            div.className = 'fileRow';
            
            const ln = document.createElement('div');
            ln.className = 'ln';
            ln.textContent = row.n;
            
            const lt = document.createElement('div');
            lt.className = 'lt';
            lt.textContent = row.t;
            
            div.appendChild(ln);
            div.appendChild(lt);
            fileBox.appendChild(div);
          });
        }catch(e){ alert('Error viewing preset: '+e); }
      };
      
      const loadBtn = document.createElement('button');
      loadBtn.className = 'btn small';
      loadBtn.textContent = 'Load';
      loadBtn.title = 'Load this preset into loop.txt';
      loadBtn.onclick = async ()=>{
        if(!confirm(`Load "${preset.name}" into loop.txt? This will replace the current loop.txt content.`)) return;
        flash(loadBtn);
        const result = await jpost('/presets/load', {filename: preset.filename});
        if(result.ok){
          alert('Preset loaded successfully!');
          if(activeFile === 'loop') loadFile(); // refresh if viewing loop
        } else {
          alert('Failed to load preset: ' + (result.error||'unknown error'));
        }
      };
      
      const delBtn = document.createElement('button');
      delBtn.className = 'btn small del';
      delBtn.textContent = 'Delete';
      delBtn.onclick = async ()=>{
        if(!confirm(`Delete preset "${preset.name}"?`)) return;
        flash(delBtn);
        const result = await jpost('/presets/delete', {filename: preset.filename});
        if(result.ok){
          loadPresets();
        } else {
          alert('Failed to delete preset: ' + (result.error||'unknown error'));
        }
      };
      
      row.appendChild(name);
      row.appendChild(loadBtn);
      row.appendChild(delBtn);
      presetsList.appendChild(row);
    });
  }catch(e){
    presetsList.textContent = '(error loading presets)';
  }
}

btnSavePreset.onclick = async (e)=>{
  const name = (presetName.value||'').trim();
  if(!name){ alert('Please enter a preset name'); return; }
  flash(e.target);
  const result = await jpost('/presets/save', {name});
  if(result.ok){
    alert('Preset saved successfully!');
    presetName.value = '';
    loadPresets();
  } else {
    alert('Failed to save preset: ' + (result.error||'unknown error'));
  }
};

btnRefreshPresets.onclick = ()=>{ flash(btnRefreshPresets); loadPresets(); };

/* ---------- Virtual Controller Logic ---------- */
const controllerOverlay = $('#controllerOverlay');
const closeOverlay = $('#closeOverlay');
const inputHistory = $('#inputHistory');
const clearHistory = $('#clearHistory');
const presetNameInput = $('#presetNameInput');
const saveHistoryPreset = $('#saveHistoryPreset');

// State for tracking held buttons
let holdIntervals = new Map(); // For alt+click auto-hold
let pressIntervals = new Map(); // For mouse-down manual hold
let inputHistoryCommands = [];
const PRESS_DELAY = '0.2s';
const HOLD_DELAY = '0.6s';

// Close overlay
closeOverlay.onclick = () => {
  controllerOverlay.style.display = 'none';
  // Release all held buttons when closing
  holdIntervals.forEach((_, btnName) => {
    let releaseCommand;
    if (btnName.includes('_STICK@')) {
      const stick = btnName.split('@')[0];
      releaseCommand = `release_stick ${stick}`;
    } else {
      releaseCommand = `release ${btnName}`;
    }
    sendControllerCommand(releaseCommand);
  });
  holdIntervals.clear();
  pressIntervals.forEach(interval => clearInterval(interval));
  pressIntervals.clear();
  document.querySelectorAll('.ctrl-btn').forEach(btn => {
    btn.classList.remove('holding', 'pressed');
  });
};

// Add command to input history
function addToInputHistory(command) {
  inputHistoryCommands.push(command);
  updateInputHistoryDisplay();
}

// Update input history display
function updateInputHistoryDisplay() {
  if (inputHistoryCommands.length === 0) {
    inputHistory.innerHTML = '<div style="color:var(--muted);font-style:italic">No inputs yet</div>';
  } else {
    // Show last 50 commands
    const recentCommands = inputHistoryCommands.slice(-50);
    inputHistory.innerHTML = recentCommands.map((cmd, i) => 
      `<div style="padding:2px 0;border-bottom:1px dotted #21283a">${inputHistoryCommands.length - 50 + i + 1}. ${cmd}</div>`
    ).join('');
    // Scroll to bottom
    inputHistory.scrollTop = inputHistory.scrollHeight;
  }
}

// Clear input history
clearHistory.onclick = () => {
  if (inputHistoryCommands.length === 0) return;
  if (!confirm('Clear all input history?')) return;
  inputHistoryCommands = [];
  updateInputHistoryDisplay();
};

// Save history to preset
saveHistoryPreset.onclick = async () => {
  const name = (presetNameInput.value || '').trim();
  if (!name) {
    alert('Please enter a preset name');
    return;
  }
  if (inputHistoryCommands.length === 0) {
    alert('No commands to save');
    return;
  }
  
  flash(saveHistoryPreset);
  
  // Save to loop.txt first
  const currentLoop = await jget('/files?which=loop');
  const originalLines = currentLoop.lines ? currentLoop.lines.map(l => l.t) : [];
  
  // Write all commands to loop.txt
  for (const cmd of inputHistoryCommands) {
    await jpost('/files/append', { which: 'loop', line: cmd });
  }
  
  // Save as preset
  const result = await jpost('/presets/save', { name });
  
  if (result.ok) {
    alert(`Preset "${name}" saved with ${inputHistoryCommands.length} commands!`);
    presetNameInput.value = '';
    loadPresets();
    
    // Restore original loop.txt
    if (originalLines.length > 0) {
      // Clear loop.txt and restore
      for (let i = 0; i < inputHistoryCommands.length; i++) {
        await jpost('/files/delete', { which: 'loop', line_number: 1 });
      }
      for (const line of originalLines) {
        await jpost('/files/append', { which: 'loop', line });
      }
    }
  } else {
    alert('Failed to save preset: ' + (result.error || 'unknown error'));
  }
};

// Send command to backend
async function sendControllerCommand(command) {
  await jpost('/program/send', { command });
  addToInputHistory(command);
}

// Handle button press start (mousedown)
function handleButtonPressStart(button) {
  const btnName = button.dataset.btn;
  
  // Don't interfere with alt+click hold
  if (holdIntervals.has(btnName)) {
    return;
  }
  
  // Visual feedback
  button.classList.add('pressed');
  
  // Send hold command for this button
  let holdCommand;
  if (btnName.includes('_STICK@')) {
    // Handle stick commands: convert to hold_stick format
    const stick = btnName.split('@')[0];
    const coords = btnName.split('@')[1];
    const x = parseInt(coords.substring(0, 4));
    const y = parseInt(coords.substring(4, 8));
    holdCommand = `hold_stick ${stick} ${x} ${y}`;
  } else {
    holdCommand = `hold ${btnName}`;
  }
  
  sendControllerCommand(holdCommand);
}

// Handle button press end (mouseup/mouseleave)
function handleButtonPressEnd(button) {
  const btnName = button.dataset.btn;
  
  // Don't interfere with alt+click hold
  if (holdIntervals.has(btnName)) {
    return;
  }
  
  // Remove visual feedback
  button.classList.remove('pressed');
  
  // Send release command for this button
  let releaseCommand;
  if (btnName.includes('_STICK@')) {
    // Handle stick commands: convert to release_stick format
    const stick = btnName.split('@')[0];
    releaseCommand = `release_stick ${stick}`;
  } else {
    releaseCommand = `release ${btnName}`;
  }
  
  sendControllerCommand(releaseCommand);
}

// Handle button hold (alt+click)
function handleButtonHold(button) {
  const btnName = button.dataset.btn;
  
  // If already holding, stop holding
  if (holdIntervals.has(btnName)) {
    clearInterval(holdIntervals.get(btnName));
    holdIntervals.delete(btnName);
    button.classList.remove('holding');
    
    // Send release command
    let releaseCommand;
    if (btnName.includes('_STICK@')) {
      const stick = btnName.split('@')[0];
      releaseCommand = `release_stick ${stick}`;
    } else {
      releaseCommand = `release ${btnName}`;
    }
    sendControllerCommand(releaseCommand);
    return;
  }
  
  // Start holding
  button.classList.add('holding');
  
  // Send hold command immediately
  let holdCommand;
  if (btnName.includes('_STICK@')) {
    const stick = btnName.split('@')[0];
    const coords = btnName.split('@')[1];
    const x = parseInt(coords.substring(0, 4));
    const y = parseInt(coords.substring(4, 8));
    holdCommand = `hold_stick ${stick} ${x} ${y}`;
  } else {
    holdCommand = `hold ${btnName}`;
  }
  
  sendControllerCommand(holdCommand);
  
  // Note: No interval needed - the hold state persists in the controller
  // We just mark it as held in the UI
  holdIntervals.set(btnName, true); // Use true instead of interval
}

// Attach event listeners to all controller buttons
document.querySelectorAll('.ctrl-btn').forEach(btn => {
  if (btn.id === 'closeOverlay') return; // Skip close button
  
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (e.altKey) {
      // Alt+click = hold/toggle auto-repeat
      handleButtonHold(btn);
    }
    // Note: Normal clicks are handled by mousedown/mouseup for press-and-hold behavior
  });
  
  btn.addEventListener('mousedown', (e) => {
    e.preventDefault();
    
    // Only handle normal (non-alt) mouse down
    if (!e.altKey) {
      handleButtonPressStart(btn);
    }
  });
  
  btn.addEventListener('mouseup', (e) => {
    e.preventDefault();
    handleButtonPressEnd(btn);
  });
  
  btn.addEventListener('mouseleave', (e) => {
    // Stop sending if mouse leaves while holding
    handleButtonPressEnd(btn);
  });
  
  // Prevent default context menu on right-click
  btn.addEventListener('contextmenu', (e) => e.preventDefault());
});

/* ---------- init ---------- */
updateTabs('loop');
loadFile();
loadPresets();
pollLogs();
</script>
</body>
</html>
